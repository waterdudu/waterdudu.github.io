<!DOCTYPE HTML>

<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title>go concurrency patterns - waterdudu blog</title>
	<meta name="author" content="map[name:dudu email:]">

	
	
	<meta name="description" content="">
	

	
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    
	<link href='/index.xml' rel="alternate" title="waterdudu blog" type="application/atom+xml">
	
	<link rel="canonical" href="http://waterdudu.github.io/post/go-concurrency-patterns/">
	<link href="http://waterdudu.github.io//favicon.png" rel="shortcut icon">
	<link href="http://waterdudu.github.io//css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="http://waterdudu.github.io//css/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="">About</a></li>
    <li><a href="/post/">Archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href='/index.xml' title="RSS">RSS</a>
		
	</div>
</nav>
</header>
			</div>
		</div>
		<div class="mid-col">
			
			<div class="mid-col-container">
				<div id="content" class="inner">
					<div itemscope itemtype="http://schema.org/Blog">
					<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="title" itemprop="name">go concurrency patterns</h1>
	<div class="entry-content" itemprop="articleBody">

<h3 id="fanin:9357571808d2807c9bcef92c59571acd">fanIn</h3>

<p>pattern</p>

<p>c &lt;- &lt;-input1 含义，把 input1 的信息拿出丢给 c</p>

<pre><code>/*
A -&gt;
       C -&gt;
B -&gt; 
*/

func fanIn(input1, input2 &lt;-chan string) &lt;-chan string {
    c := make(chan string)

    go func() { for { c &lt;- &lt;-input1 } }()
    go func() { for { c &lt;- &lt;-input2 } }()
    return c
}

func main() {
    c := fanIn(boring(&quot;Joe&quot;), boring(&quot;Ann&quot;))
    for i := 0; i &lt; 10; i++ {
        fmt.Println(&lt;-c)
    }
    fmt.Println(&quot;You're both boring. I'm leaving&quot;)
}

</code></pre>

<h3 id="channel-of-channel:9357571808d2807c9bcef92c59571acd">channel of channel</h3>

<pre><code>// +build OMIT

package main

import (
    &quot;fmt&quot;
    &quot;math/rand&quot;
    &quot;time&quot;
)

type Message struct {
    str string
    wait chan bool
}

func main() {
    c := fanIn(boring(&quot;Joe&quot;), boring(&quot;Ann&quot;)) // HL

    // main 函数等待五次
    // 先从 fanIn 返回的 channel 里读 message（这是一个 Message 的 channel）
    // 读到消息（boring 函数里的 c &lt;- Message 这句），则打印输出
    // 接下来再从 fanIn 的 channel 里读数据 ，读出来再打印输出

    // 接下来再设置 msg1, msg2 的 wait channel（共享的）为true
    // 告诉 boring 运行的 goroutine 可以再生产啦！
    // 于是那两个 goroutine 就又开始塞数据了（c &lt;- Message{}）

    // 注意：每次都是 msg1.wait &lt;- true, msg2.wait &lt;- true 
    // 告诉 goroutine，可以再给我数据了
    for i := 0; i &lt; 5; i++ {
        msg1 := &lt;-c; fmt.Println(msg1.str)
        msg2 := &lt;-c; fmt.Println(msg2.str)
        msg1.wait &lt;- true
        msg2.wait &lt;- true
    }

    fmt.Println(&quot;You're all boring; I'm leaving.&quot;)
}

func boring(msg string) &lt;-chan Message { // Returns receive-only channel of strings.

    // boring 的 goroutine 循环写数据，写完数据睡一会儿，起来看看是不是需要再 wait
    // 如果不需要再 wait，那么就退出
    // 写完再继续写，直到 main 退出

    c := make(chan Message)

    // 多个 Message 共享这个 waitForIt channel
    // 当 main 函数连续调用 msg.wait &lt;- true 时
    // 下面的 func 函数被调用
    //（&lt;-waitForIt 是 block 的，如果 main 函数不丢信息到 wait channel，func不会调用）
    waitForIt := make(chan bool) // Shared between all messages.

    go func() { // We launch the goroutine from inside the function.
        for i := 0; ; i++ {

            c &lt;- Message{ fmt.Sprintf(&quot;%s: %d&quot;, msg, i), waitForIt }
            time.Sleep(time.Duration(rand.Intn(2e3)) * time.Millisecond)
            // 如果 main 函数不通过 msg.wait &lt;- true 写数据，func 会 block
            &lt;-waitForIt

        }
    }()

    return c
}


// 参考 fakeIn 的 pattern
// 把来参数列表的多个 channel 合并到一个 channel
func fanIn(inputs ... &lt;-chan Message) &lt;-chan Message {
    c := make(chan Message)
    for i := range inputs {
        input := inputs[i] // New instance of 'input' for each loop.
        go func() { for { c &lt;- &lt;-input } }()
    }
    return c
}


</code></pre>
</div></article>
					
						<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size=''></a>
	
	
	</div>
	
  	<script type="text/javascript" src='http://s7.addthis.com/js/250/addthis_widget.js#pubid='></script>
  	
</div>

					
					
					


				    </div>
				</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    dudu

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
<script src="http://waterdudu.github.io//js/slash.js"></script>
<script src="http://waterdudu.github.io//js/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script></footer>
		</div>
	</div>
	
</body>
</html>
